import { BaseLoginProvider } from '../entities/base-login-provider';
import { SocialUser } from '../entities/social-user';
import { EventEmitter } from '@angular/core';
import { BehaviorSubject } from 'rxjs';
import { filter, skip, take } from 'rxjs/operators';
const defaultInitOptions = {
    oneTapEnabled: true,
};
class GoogleLoginProvider extends BaseLoginProvider {
    static { this.PROVIDER_ID = 'GOOGLE'; }
    constructor(clientId, initOptions) {
        super();
        this.clientId = clientId;
        this.initOptions = initOptions;
        this.changeUser = new EventEmitter();
        this._socialUser = new BehaviorSubject(null);
        this._accessToken = new BehaviorSubject(null);
        this._receivedAccessToken = new EventEmitter();
        this.initOptions = { ...defaultInitOptions, ...this.initOptions };
        // emit changeUser events but skip initial value from behaviorSubject
        this._socialUser.pipe(skip(1)).subscribe(this.changeUser);
        // emit receivedAccessToken but skip initial value from behaviorSubject
        this._accessToken.pipe(skip(1)).subscribe(this._receivedAccessToken);
    }
    initialize(autoLogin) {
        return new Promise((resolve, reject) => {
            try {
                this.loadScript(GoogleLoginProvider.PROVIDER_ID, 'https://accounts.google.com/gsi/client', () => {
                    google.accounts.id.initialize({
                        client_id: this.clientId,
                        auto_select: autoLogin,
                        callback: ({ credential }) => {
                            const socialUser = this.createSocialUser(credential);
                            this._socialUser.next(socialUser);
                        },
                        prompt_parent_id: this.initOptions?.prompt_parent_id,
                        itp_support: this.initOptions.oneTapEnabled
                    });
                    if (this.initOptions.oneTapEnabled) {
                        this._socialUser
                            .pipe(filter((user) => user === null))
                            .subscribe(() => google.accounts.id.prompt(console.debug));
                    }
                    if (this.initOptions.scopes) {
                        const scope = this.initOptions.scopes instanceof Array
                            ? this.initOptions.scopes.filter((s) => s).join(' ')
                            : this.initOptions.scopes;
                        this._tokenClient = google.accounts.oauth2.initTokenClient({
                            client_id: this.clientId,
                            scope,
                            prompt: this.initOptions.prompt,
                            callback: (tokenResponse) => {
                                if (tokenResponse.error) {
                                    this._accessToken.error({
                                        code: tokenResponse.error,
                                        description: tokenResponse.error_description,
                                        uri: tokenResponse.error_uri,
                                    });
                                }
                                else {
                                    this._accessToken.next(tokenResponse.access_token);
                                }
                            },
                        });
                    }
                    resolve();
                });
            }
            catch (err) {
                reject(err);
            }
        });
    }
    getLoginStatus() {
        return new Promise((resolve, reject) => {
            if (this._socialUser.value) {
                resolve(this._socialUser.value);
            }
            else {
                reject(`No user is currently logged in with ${GoogleLoginProvider.PROVIDER_ID}`);
            }
        });
    }
    refreshToken() {
        return new Promise((resolve, reject) => {
            google.accounts.id.revoke(this._socialUser.value.id, (response) => {
                if (response.error)
                    reject(response.error);
                else
                    resolve(this._socialUser.value);
            });
        });
    }
    getAccessToken() {
        return new Promise((resolve, reject) => {
            if (!this._tokenClient) {
                if (this._socialUser.value) {
                    reject('No token client was instantiated, you should specify some scopes.');
                }
                else {
                    reject('You should be logged-in first.');
                }
            }
            else {
                this._tokenClient.requestAccessToken({
                    hint: this._socialUser.value?.email,
                });
                this._receivedAccessToken.pipe(take(1)).subscribe(resolve);
            }
        });
    }
    revokeAccessToken() {
        return new Promise((resolve, reject) => {
            if (!this._tokenClient) {
                reject('No token client was instantiated, you should specify some scopes.');
            }
            else if (!this._accessToken.value) {
                reject('No access token to revoke');
            }
            else {
                google.accounts.oauth2.revoke(this._accessToken.value, () => {
                    this._accessToken.next(null);
                    resolve();
                });
            }
        });
    }
    signIn() {
        return Promise.reject('You should not call this method directly for Google, use "<asl-google-signin-button>" wrapper ' +
            'or generate the button yourself with "google.accounts.id.renderButton()" ' +
            '(https://developers.google.com/identity/gsi/web/guides/display-button#javascript)');
    }
    async signOut() {
        google.accounts.id.disableAutoSelect();
        this._socialUser.next(null);
    }
    createSocialUser(idToken) {
        const user = new SocialUser();
        user.idToken = idToken;
        const payload = this.decodeJwt(idToken);
        user.id = payload.sub;
        user.name = payload.name;
        user.email = payload.email;
        user.photoUrl = payload.picture;
        user.firstName = payload['given_name'];
        user.lastName = payload['family_name'];
        return user;
    }
    decodeJwt(idToken) {
        const base64Url = idToken.split(".")[1];
        const base64 = base64Url.replace(/-/g, "+").replace(/_/g, "/");
        const jsonPayload = decodeURIComponent(window.atob(base64)
            .split("")
            .map(function (c) {
            return "%" + ("00" + c.charCodeAt(0).toString(16)).slice(-2);
        })
            .join(""));
        return JSON.parse(jsonPayload);
    }
}
export { GoogleLoginProvider };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ29vZ2xlLWxvZ2luLXByb3ZpZGVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vcHJvamVjdHMvbGliL3NyYy9wcm92aWRlcnMvZ29vZ2xlLWxvZ2luLXByb3ZpZGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxpQkFBaUIsRUFBRSxNQUFNLGlDQUFpQyxDQUFDO0FBQ3BFLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSx5QkFBeUIsQ0FBQztBQUNyRCxPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzdDLE9BQU8sRUFBRSxlQUFlLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDdkMsT0FBTyxFQUFFLE1BQU0sRUFBRSxJQUFJLEVBQUUsSUFBSSxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUErQnBELE1BQU0sa0JBQWtCLEdBQXNCO0lBQzVDLGFBQWEsRUFBRSxJQUFJO0NBQ3BCLENBQUM7QUFFRixNQUFhLG1CQUFvQixTQUFRLGlCQUFpQjthQUNqQyxnQkFBVyxHQUFXLFFBQVEsQUFBbkIsQ0FBb0I7SUFTdEQsWUFDVSxRQUFnQixFQUNQLFdBQStCO1FBRWhELEtBQUssRUFBRSxDQUFDO1FBSEEsYUFBUSxHQUFSLFFBQVEsQ0FBUTtRQUNQLGdCQUFXLEdBQVgsV0FBVyxDQUFvQjtRQVRsQyxlQUFVLEdBQUcsSUFBSSxZQUFZLEVBQXFCLENBQUM7UUFFbEQsZ0JBQVcsR0FBRyxJQUFJLGVBQWUsQ0FBb0IsSUFBSSxDQUFDLENBQUM7UUFDM0QsaUJBQVksR0FBRyxJQUFJLGVBQWUsQ0FBZ0IsSUFBSSxDQUFDLENBQUM7UUFDeEQseUJBQW9CLEdBQUcsSUFBSSxZQUFZLEVBQVUsQ0FBQztRQVNqRSxJQUFJLENBQUMsV0FBVyxHQUFHLEVBQUUsR0FBRyxrQkFBa0IsRUFBRSxHQUFHLElBQUksQ0FBQyxXQUFXLEVBQUUsQ0FBQztRQUVsRSxxRUFBcUU7UUFDckUsSUFBSSxDQUFDLFdBQVcs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Q0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQy9ELENBQUMsQ0FBQzthQUNELElBQUksQ0FBQyxFQUFFLENBQUMsQ0FDWixDQUFDO1FBQ0YsT0FBTyxJQUFJLENBQUMsS0FBSyxDQUFDLFdBQVcsQ0FBQyxDQUFDO0lBQ2pDLENBQUM7O1NBakxVLG1CQUFtQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEJhc2VMb2dpblByb3ZpZGVyIH0gZnJvbSAnLi4vZW50aXRpZXMvYmFzZS1sb2dpbi1wcm92aWRlcic7XHJcbmltcG9ydCB7IFNvY2lhbFVzZXIgfSBmcm9tICcuLi9lbnRpdGllcy9zb2NpYWwtdXNlcic7XHJcbmltcG9ydCB7IEV2ZW50RW1pdHRlciB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5pbXBvcnQgeyBCZWhhdmlvclN1YmplY3QgfSBmcm9tICdyeGpzJztcclxuaW1wb3J0IHsgZmlsdGVyLCBza2lwLCB0YWtlIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xyXG5cclxuZXhwb3J0IGludGVyZmFjZSBHb29nbGVJbml0T3B0aW9ucyB7XHJcbiAgLyoqXHJcbiAgICogZW5hYmxlcyB0aGUgT25lIFRhcCBtZWNoYW5pc20sIGFuZCBtYWtlcyBhdXRvLWxvZ2luIHBvc3NpYmxlXHJcbiAgICovXHJcbiAgb25lVGFwRW5hYmxlZD86IGJvb2xlYW47XHJcbiAgLyoqXHJcbiAgICogbGlzdCBvZiBwZXJtaXNzaW9uIHNjb3BlcyB0byBncmFudCBpbiBjYXNlIHdlIHJlcXVlc3QgYW4gYWNjZXNzIHRva2VuXHJcbiAgICovXHJcbiAgc2NvcGVzPzogc3RyaW5nIHwgc3RyaW5nW107XHJcbiAvKipcclxuICAgKiBUaGlzIGF0dHJpYnV0ZSBzZXRzIHRoZSBET00gSUQgb2YgdGhlIGNvbnRhaW5lciBlbGVtZW50LiBJZiBpdCdzIG5vdCBzZXQsIHRoZSBPbmUgVGFwIHByb21wdCBpcyBkaXNwbGF5ZWQgaW4gdGhlIHRvcC1yaWdodCBjb3JuZXIgb2YgdGhlIHdpbmRvdy5cclxuICAgKi9cclxuICBwcm9tcHRfcGFyZW50X2lkPzogc3RyaW5nO1xyXG5cclxuICAvKipcclxuICAgKiBPcHRpb25hbCwgZGVmYXVsdHMgdG8gJ3NlbGVjdF9hY2NvdW50Jy5cclxuICAgKiBBIHNwYWNlLWRlbGltaXRlZCwgY2FzZS1zZW5zaXRpdmUgbGlzdCBvZiBwcm9tcHRzIHRvIHByZXNlbnQgdGhlXHJcbiAgICogdXNlci5cclxuICAgKiBQb3NzaWJsZSB2YWx1ZXMgYXJlOlxyXG4gICAqIGVtcHR5IHN0cmluZyBUaGUgdXNlciB3aWxsIGJlIHByb21wdGVkIG9ubHkgdGhlIGZpcnN0IHRpbWUgeW91clxyXG4gICAqICAgICBhcHAgcmVxdWVzdHMgYWNjZXNzLiBDYW5ub3QgYmUgc3BlY2lmaWVkIHdpdGggb3RoZXIgdmFsdWVzLlxyXG4gICAqICdub25lJyBEbyBub3QgZGlzcGxheSBhbnkgYXV0aGVudGljYXRpb24gb3IgY29uc2VudCBzY3JlZW5zLiBNdXN0XHJcbiAgICogICAgIG5vdCBiZSBzcGVjaWZpZWQgd2l0aCBvdGhlciB2YWx1ZXMuXHJcbiAgICogJ2NvbnNlbnQnIFByb21wdCB0aGUgdXNlciBmb3IgY29uc2VudC5cclxuICAgKiAnc2VsZWN0X2FjY291bnQnIFByb21wdCB0aGUgdXNlciB0byBzZWxlY3QgYW4gYWNjb3VudC5cclxuICAgKi9cclxuICBwcm9tcHQ/IDogJycgfCAnbm9uZScgfCAnY29uc2VudCcgfCAnc2VsZWN0X2FjY291bnQnO1xyXG59XHJcblxyXG5jb25zdCBkZWZhdWx0SW5pdE9wdGlvbnM6IEdvb2dsZUluaXRPcHRpb25zID0ge1xyXG4gIG9uZVRhcEVuYWJsZWQ6IHRydWUsXHJcbn07XHJcblxyXG5leHBvcnQgY2xhc3MgR29vZ2xlTG9naW5Qcm92aWRlciBleHRlbmRzIEJhc2VMb2dpblByb3ZpZGVyIHtcclxuICBwdWJsaWMgc3RhdGljIHJlYWRvbmx5IFBST1ZJREVSX0lEOiBzdHJpbmcgPSAnR09PR0xFJztcclxuXHJcbiAgcHVibGljIHJlYWRvbmx5IGNoYW5nZVVzZXIgPSBuZXcgRXZlbnRFbWl0dGVyPFNvY2lhbFVzZXIgfCBudWxsPigpO1xyXG5cclxuICBwcml2YXRlIHJlYWRvbmx5IF9zb2NpYWxVc2VyID0gbmV3IEJlaGF2aW9yU3ViamVjdDxTb2NpYWxVc2VyIHwgbnVsbD4obnVsbCk7XHJcbiAgcHJpdmF0ZSByZWFkb25seSBfYWNjZXNzVG9rZW4gPSBuZXcgQmVoYXZpb3JTdWJqZWN0PHN0cmluZyB8IG51bGw+KG51bGwpO1xyXG4gIHByaXZhdGUgcmVhZG9ubHkgX3JlY2VpdmVkQWNjZXNzVG9rZW4gPSBuZXcgRXZlbnRFbWl0dGVyPHN0cmluZz4oKTtcclxuICBwcml2YXRlIF90b2tlbkNsaWVudDogZ29vZ2xlLmFjY291bnRzLm9hdXRoMi5Ub2tlbkNsaWVudCB8IHVuZGVmaW5lZDtcclxuXHJcbiAgY29uc3RydWN0b3IoXHJcbiAgICBwcml2YXRlIGNsaWVudElkOiBzdHJpbmcsXHJcbiAgICBwcml2YXRlIHJlYWRvbmx5IGluaXRPcHRpb25zPzogR29vZ2xlSW5pdE9wdGlvbnNcclxuICApIHtcclxuICAgIHN1cGVyKCk7XHJcblxyXG4gICAgdGhpcy5pbml0T3B0aW9ucyA9IHsgLi4uZGVmYXVsdEluaXRPcHRpb25zLCAuLi50aGlzLmluaXRPcHRpb25zIH07XHJcblxyXG4gICAgLy8gZW1pdCBjaGFuZ2VVc2VyIGV2ZW50cyBidXQgc2tpcCBpbml0aWFsIHZhbHVlIGZyb20gYmVoYXZpb3JTdWJqZWN0XHJcbiAgICB0aGlzLl9zb2NpYWxVc2VyLnBpcGUoc2tpcCgxKSkuc3Vic2NyaWJlKHRoaXMuY2hhbmdlVXNlcik7XHJcblxyXG4gICAgLy8gZW1pdCByZWNlaXZlZEFjY2Vzc1Rva2VuIGJ1dCBza2lwIGluaXRpYWwgdmFsdWUgZnJvbSBiZWhhdmlvclN1YmplY3RcclxuICAgIHRoaXMuX2FjY2Vzc1Rva2VuLnBpcGUoc2tpcCgxKSkuc3Vic2NyaWJlKHRoaXMuX3JlY2VpdmVkQWNjZXNzVG9rZW4pO1xyXG4gIH1cclxuXHJcbiAgaW5pdGlhbGl6ZShhdXRvTG9naW4/OiBib29sZWFuKTogUHJvbWlzZTx2b2lkPiB7XHJcbiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xyXG4gICAgICB0cnkge1xyXG4gICAgICAgIHRoaXMubG9hZFNjcmlwdChcclxuICAgICAgICAgIEdvb2dsZUxvZ2luUHJvdmlkZXIuUFJPVklERVJfSUQsXHJcbiAgICAgICAgICAnaHR0cHM6Ly9hY2NvdW50cy5nb29nbGUuY29tL2dzaS9jbGllbnQnLFxyXG4gICAgICAgICAgKCkgPT4ge1xyXG4gICAgICAgICAgICBnb29nbGUuYWNjb3VudHMuaWQuaW5pdGlhbGl6ZSh7XHJcbiAgICAgICAgICAgICAgY2xpZW50X2lkOiB0aGlzLmNsaWVudElkLFxyXG4gICAgICAgICAgICAgIGF1dG9fc2VsZWN0OiBhdXRvTG9naW4sXHJcbiAgICAgICAgICAgICAgY2FsbGJhY2s6ICh7IGNyZWRlbnRpYWwgfSkgPT4ge1xyXG4gICAgICAgICAgICAgICAgY29uc3Qgc29jaWFsVXNlciA9IHRoaXMuY3JlYXRlU29jaWFsVXNlcihjcmVkZW50aWFsKTtcclxuICAgICAgICAgICAgICAgIHRoaXMuX3NvY2lhbFVzZXIubmV4dChzb2NpYWxVc2VyKTtcclxuICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAgIHByb21wdF9wYXJlbnRfaWQ6IHRoaXMuaW5pdE9wdGlvbnM/LnByb21wdF9wYXJlbnRfaWQsXHJcbiAgICAgICAgICAgICAgaXRwX3N1cHBvcnQ6IHRoaXMuaW5pdE9wdGlvbnMub25lVGFwRW5hYmxlZFxyXG4gICAgICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgICAgIGlmICh0aGlzLmluaXRPcHRpb25zLm9uZVRhcEVuYWJsZWQpIHtcclxuICAgICAgICAgICAgICB0aGlzLl9zb2NpYWxVc2VyXHJcbiAgICAgICAgICAgICAgICAucGlwZShmaWx0ZXIoKHVzZXIpID0+IHVzZXIgPT09IG51bGwpKVxyXG4gICAgICAgICAgICAgICAgLnN1YnNjcmliZSgoKSA9PiBnb29nbGUuYWNjb3VudHMuaWQucHJvbXB0KGNvbnNvbGUuZGVidWcpKTtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgaWYgKHRoaXMuaW5pdE9wdGlvbnMuc2NvcGVzKSB7XHJcbiAgICAgICAgICAgICAgY29uc3Qgc2NvcGUgPVxyXG4gICAgICAgICAgICAgICAgdGhpcy5pbml0T3B0aW9ucy5zY29wZXMgaW5zdGFuY2VvZiBBcnJheVxyXG4gICAgICAgICAgICAgICAgICA/IHRoaXMuaW5pdE9wdGlvbnMuc2NvcGVzLmZpbHRlcigocykgPT4gcykuam9pbignICcpXHJcbiAgICAgICAgICAgICAgICAgIDogdGhpcy5pbml0T3B0aW9ucy5zY29wZXM7XHJcblxyXG4gICAgICAgICAgICAgIHRoaXMuX3Rva2VuQ2xpZW50ID0gZ29vZ2xlLmFjY291bnRzLm9hdXRoMi5pbml0VG9rZW5DbGllbnQoe1xyXG4gICAgICAgICAgICAgICAgY2xpZW50X2lkOiB0aGlzLmNsaWVudElkLFxyXG4gICAgICAgICAgICAgICAgc2NvcGUsXHJcbiAgICAgICAgICAgICAgICBwcm9tcHQgOiB0aGlzLmluaXRPcHRpb25zLnByb21wdCxcclxuICAgICAgICAgICAgICAgIGNhbGxiYWNrOiAodG9rZW5SZXNwb25zZSkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICBpZiAodG9rZW5SZXNwb25zZS5lcnJvcikge1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuX2FjY2Vzc1Rva2VuLmVycm9yKHtcclxuICAgICAgICAgICAgICAgICAgICAgIGNvZGU6IHRva2VuUmVzcG9uc2UuZXJyb3IsXHJcbiAgICAgICAgICAgICAgICAgICAgICBkZXNjcmlwdGlvbjogdG9rZW5SZXNwb25zZS5lcnJvcl9kZXNjcmlwdGlvbixcclxuICAgICAgICAgICAgICAgICAgICAgIHVyaTogdG9rZW5SZXNwb25zZS5lcnJvcl91cmksXHJcbiAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5fYWNjZXNzVG9rZW4ubmV4dCh0b2tlblJlc3BvbnNlLmFjY2Vzc190b2tlbik7XHJcbiAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIHJlc29sdmUoKTtcclxuICAgICAgICAgIH1cclxuICAgICAgICApO1xyXG4gICAgICB9IGNhdGNoIChlcnIpIHtcclxuICAgICAgICByZWplY3QoZXJyKTtcclxuICAgICAgfVxyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICBnZXRMb2dpblN0YXR1cygpOiBQcm9taXNlPFNvY2lhbFVzZXI+IHtcclxuICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XHJcbiAgICAgIGlmICh0aGlzLl9zb2NpYWxVc2VyLnZhbHVlKSB7XHJcbiAgICAgICAgcmVzb2x2ZSh0aGlzLl9zb2NpYWxVc2VyLnZhbHVlKTtcclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICByZWplY3QoXHJcbiAgICAgICAgICBgTm8gdXNlciBpcyBjdXJyZW50bHkgbG9nZ2VkIGluIHdpdGggJHtHb29nbGVMb2dpblByb3ZpZGVyLlBST1ZJREVSX0lEfWBcclxuICAgICAgICApO1xyXG4gICAgICB9XHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIHJlZnJlc2hUb2tlbigpOiBQcm9taXNlPFNvY2lhbFVzZXIgfCBudWxsPiB7XHJcbiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xyXG4gICAgICBnb29nbGUuYWNjb3VudHMuaWQucmV2b2tlKHRoaXMuX3NvY2lhbFVzZXIudmFsdWUuaWQsIChyZXNwb25zZSkgPT4ge1xyXG4gICAgICAgIGlmIChyZXNwb25zZS5lcnJvcikgcmVqZWN0KHJlc3BvbnNlLmVycm9yKTtcclxuICAgICAgICBlbHNlIHJlc29sdmUodGhpcy5fc29jaWFsVXNlci52YWx1ZSk7XHJcbiAgICAgIH0pO1xyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICBnZXRBY2Nlc3NUb2tlbigpOiBQcm9taXNlPHN0cmluZz4ge1xyXG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcclxuICAgICAgaWYgKCF0aGlzLl90b2tlbkNsaWVudCkge1xyXG4gICAgICAgIGlmICh0aGlzLl9zb2NpYWxVc2VyLnZhbHVlKSB7XHJcbiAgICAgICAgICByZWplY3QoXHJcbiAgICAgICAgICAgICdObyB0b2tlbiBjbGllbnQgd2FzIGluc3RhbnRpYXRlZCwgeW91IHNob3VsZCBzcGVjaWZ5IHNvbWUgc2NvcGVzLidcclxuICAgICAgICAgICk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgIHJlamVjdCgnWW91IHNob3VsZCBiZSBsb2dnZWQtaW4gZmlyc3QuJyk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIHRoaXMuX3Rva2VuQ2xpZW50LnJlcXVlc3RBY2Nlc3NUb2tlbih7XHJcbiAgICAgICAgICBoaW50OiB0aGlzLl9zb2NpYWxVc2VyLnZhbHVlPy5lbWFpbCxcclxuICAgICAgICB9KTtcclxuICAgICAgICB0aGlzLl9yZWNlaXZlZEFjY2Vzc1Rva2VuLnBpcGUodGFrZSgxKSkuc3Vic2NyaWJlKHJlc29sdmUpO1xyXG4gICAgICB9XHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIHJldm9rZUFjY2Vzc1Rva2VuKCk6IFByb21pc2U8dm9pZD4ge1xyXG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcclxuICAgICAgaWYgKCF0aGlzLl90b2tlbkNsaWVudCkge1xyXG4gICAgICAgIHJlamVjdChcclxuICAgICAgICAgICdObyB0b2tlbiBjbGllbnQgd2FzIGluc3RhbnRpYXRlZCwgeW91IHNob3VsZCBzcGVjaWZ5IHNvbWUgc2NvcGVzLidcclxuICAgICAgICApO1xyXG4gICAgICB9IGVsc2UgaWYgKCF0aGlzLl9hY2Nlc3NUb2tlbi52YWx1ZSkge1xyXG4gICAgICAgIHJlamVjdCgnTm8gYWNjZXNzIHRva2VuIHRvIHJldm9rZScpO1xyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIGdvb2dsZS5hY2NvdW50cy5vYXV0aDIucmV2b2tlKHRoaXMuX2FjY2Vzc1Rva2VuLnZhbHVlLCAoKSA9PiB7XHJcbiAgICAgICAgICB0aGlzLl9hY2Nlc3NUb2tlbi5uZXh0KG51bGwpO1xyXG4gICAgICAgICAgcmVzb2x2ZSgpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgICB9XHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIHNpZ25JbigpOiBQcm9taXNlPFNvY2lhbFVzZXI+IHtcclxuICAgIHJldHVybiBQcm9taXNlLnJlamVjdChcclxuICAgICAgJ1lvdSBzaG91bGQgbm90IGNhbGwgdGhpcyBtZXRob2QgZGlyZWN0bHkgZm9yIEdvb2dsZSwgdXNlIFwiPGFzbC1nb29nbGUtc2lnbmluLWJ1dHRvbj5cIiB3cmFwcGVyICcgK1xyXG4gICAgICAgICdvciBnZW5lcmF0ZSB0aGUgYnV0dG9uIHlvdXJzZWxmIHdpdGggXCJnb29nbGUuYWNjb3VudHMuaWQucmVuZGVyQnV0dG9uKClcIiAnICtcclxuICAgICAgICAnKGh0dHBzOi8vZGV2ZWxvcGVycy5nb29nbGUuY29tL2lkZW50aXR5L2dzaS93ZWIvZ3VpZGVzL2Rpc3BsYXktYnV0dG9uI2phdmFzY3JpcHQpJ1xyXG4gICAgKTtcclxuICB9XHJcblxyXG4gIGFzeW5jIHNpZ25PdXQoKTogUHJvbWlzZTx2b2lkPiB7XHJcbiAgICBnb29nbGUuYWNjb3VudHMuaWQuZGlzYWJsZUF1dG9TZWxlY3QoKTtcclxuICAgIHRoaXMuX3NvY2lhbFVzZXIubmV4dChudWxsKTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgY3JlYXRlU29jaWFsVXNlcihpZFRva2VuOiBzdHJpbmcpIHtcclxuICAgIGNvbnN0IHVzZXIgPSBuZXcgU29jaWFsVXNlcigpO1xyXG4gICAgdXNlci5pZFRva2VuID0gaWRUb2tlbjtcclxuICAgIGNvbnN0IHBheWxvYWQgPSB0aGlzLmRlY29kZUp3dChpZFRva2VuKTtcclxuICAgIHVzZXIuaWQgPSBwYXlsb2FkLnN1YjtcclxuICAgIHVzZXIubmFtZSA9IHBheWxvYWQubmFtZTtcclxuICAgIHVzZXIuZW1haWwgPSBwYXlsb2FkLmVtYWlsO1xyXG4gICAgdXNlci5waG90b1VybCA9IHBheWxvYWQucGljdHVyZTtcclxuICAgIHVzZXIuZmlyc3ROYW1lID0gcGF5bG9hZFsnZ2l2ZW5fbmFtZSddO1xyXG4gICAgdXNlci5sYXN0TmFtZSA9IHBheWxvYWRbJ2ZhbWlseV9uYW1lJ107XHJcbiAgICByZXR1cm4gdXNlcjtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgZGVjb2RlSnd0KGlkVG9rZW46IHN0cmluZyk6IFJlY29yZDxzdHJpbmcsIHN0cmluZyB8IHVuZGVmaW5lZD4ge1xyXG4gICAgY29uc3QgYmFzZTY0VXJsID0gaWRUb2tlbi5zcGxpdChcIi5cIilbMV07XHJcbiAgICBjb25zdCBiYXNlNjQgPSBiYXNlNjRVcmwucmVwbGFjZSgvLS9nLCBcIitcIikucmVwbGFjZSgvXy9nLCBcIi9cIik7XHJcbiAgICBjb25zdCBqc29uUGF5bG9hZCA9IGRlY29kZVVSSUNvbXBvbmVudChcclxuICAgICAgd2luZG93LmF0b2IoYmFzZTY0KVxyXG4gICAgICAgIC5zcGxpdChcIlwiKVxyXG4gICAgICAgIC5tYXAoZnVuY3Rpb24gKGMpIHtcclxuICAgICAgICAgIHJldHVybiBcIiVcIiArIChcIjAwXCIgKyBjLmNoYXJDb2RlQXQoMCkudG9TdHJpbmcoMTYpKS5zbGljZSgtMik7XHJcbiAgICAgICAgfSlcclxuICAgICAgICAuam9pbihcIlwiKVxyXG4gICAgKTtcclxuICAgIHJldHVybiBKU09OLnBhcnNlKGpzb25QYXlsb2FkKTtcclxuICB9XHJcbn1cclxuIl19